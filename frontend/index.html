<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AGI Desktop Agent</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg-void: #07080a; --bg-base: #0c0e12; --bg-surface: #12151b;
  --bg-raised: #181c24; --bg-hover: #1e2330;
  --border-subtle: #1e2330; --border-medium: #2a3040; --border-focus: #3ecf8e;
  --text-primary: #e4e8ef; --text-secondary: #8891a4; --text-muted: #5a6478;
  --accent: #3ecf8e; --accent-dim: #2a9d6b;
  --accent-glow: rgba(62,207,142,0.12); --accent-glow-strong: rgba(62,207,142,0.25);
  --warning: #f0b429; --error: #ef4444; --info: #60a5fa; --purple: #a855f7; --pink: #fb7185;
  --user-bubble: #1a2332; --agent-bubble: #141820;
  --radius-sm: 6px; --radius-md: 10px; --radius-lg: 16px;
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
  --font-sans: 'DM Sans', -apple-system, sans-serif;
  --transition: 180ms cubic-bezier(0.4, 0, 0.2, 1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg-void);color:var(--text-primary);font-family:var(--font-sans);font-size:14px;line-height:1.6;-webkit-font-smoothing:antialiased;overflow:hidden}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border-medium);border-radius:3px}

.app{display:grid;grid-template-columns:auto 1fr 290px;grid-template-rows:52px 1fr;height:100vh}

/* TOPBAR */
.topbar{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:var(--bg-base);border-bottom:1px solid var(--border-subtle);z-index:10}
.topbar-brand{display:flex;align-items:center;gap:10px}
.topbar-logo{width:30px;height:30px;background:linear-gradient(135deg,var(--accent),var(--accent-dim));border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 0 16px var(--accent-glow)}
.topbar-title{font-family:var(--font-mono);font-weight:600;font-size:14px;letter-spacing:-0.02em}
.topbar-title span{color:var(--accent)}
.topbar-right{display:flex;align-items:center;gap:14px}
.status-badge{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-muted);font-family:var(--font-mono)}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent-glow-strong);animation:pulse 2s ease-in-out infinite}
.status-dot.offline{background:var(--error);box-shadow:none;animation:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.privacy-toggle{display:flex;align-items:center;gap:8px;font-size:11px;font-family:var(--font-mono);color:var(--text-muted)}
.privacy-toggle label{cursor:pointer;display:flex;align-items:center;gap:6px}
.toggle-track{width:34px;height:18px;background:var(--border-medium);border-radius:9px;position:relative;transition:background var(--transition);cursor:pointer}
.toggle-track.on{background:var(--accent-dim)}
.toggle-knob{width:14px;height:14px;background:var(--text-primary);border-radius:50%;position:absolute;top:2px;left:2px;transition:left var(--transition)}
.toggle-track.on .toggle-knob{left:18px}
.privacy-engine{font-size:9px;color:var(--text-muted);opacity:.6}

/* SIDEBAR */
.sidebar{background:var(--bg-base);border-right:1px solid var(--border-subtle);display:flex;flex-direction:column;overflow:hidden;width:260px;transition:width 300ms cubic-bezier(0.4,0,0.2,1),opacity 200ms ease;opacity:1}
.sidebar.collapsed{width:0;opacity:0;border-right:none;padding:0}
.sidebar-inner{width:260px;min-width:260px;display:flex;flex-direction:column;height:100%;overflow-y:auto}
.sidebar-toggle{width:32px;height:32px;border-radius:var(--radius-sm);border:1px solid var(--border-medium);background:var(--bg-surface);color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all var(--transition);flex-shrink:0}
.sidebar-toggle:hover{background:var(--bg-hover);color:var(--text-secondary);border-color:var(--accent-dim)}
.sidebar-toggle svg{width:16px;height:16px;transition:transform 300ms cubic-bezier(0.4,0,0.2,1)}
.sidebar-toggle.collapsed svg{transform:rotate(180deg)}
.sidebar-section{padding:14px;border-bottom:1px solid var(--border-subtle)}.sidebar-section:last-child{border-bottom:none}
.sidebar-label{font-family:var(--font-mono);font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--text-muted);margin-bottom:8px}
.tool-list{list-style:none;display:flex;flex-direction:column;gap:1px;overflow-y:auto;max-height:340px}
.tool-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:var(--radius-sm);cursor:default;transition:background var(--transition);font-size:12.5px}
.tool-item:hover{background:var(--bg-hover)}
.tool-icon{width:22px;height:22px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.tool-icon.search{background:rgba(62,207,142,.12);color:var(--accent)}.tool-icon.email{background:rgba(96,165,250,.12);color:var(--info)}.tool-icon.doc{background:rgba(240,180,41,.12);color:var(--warning)}.tool-icon.cal{background:rgba(168,85,247,.12);color:var(--purple)}.tool-icon.mem{background:rgba(251,113,133,.12);color:var(--pink)}
.tool-name{color:var(--text-secondary);font-size:12.5px}
.quick-actions{display:flex;flex-direction:column;gap:4px}
.quick-action{background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);padding:9px 11px;color:var(--text-secondary);font-size:12px;font-family:var(--font-sans);cursor:pointer;transition:all var(--transition);text-align:left;line-height:1.4}
.quick-action:hover{background:var(--bg-hover);border-color:var(--border-medium);color:var(--text-primary)}
.quick-action .qa-label{display:block;font-family:var(--font-mono);font-size:10px;color:var(--text-muted);margin-bottom:2px}

/* CHAT */
.chat-area{display:flex;flex-direction:column;background:var(--bg-void);overflow:hidden}
.messages{flex:1;overflow-y:auto;padding:20px 24px 12px;display:flex;flex-direction:column;gap:14px}
.message{display:flex;gap:10px;max-width:85%;animation:msgIn 300ms cubic-bezier(.16,1,.3,1) both}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.message.user{align-self:flex-end;flex-direction:row-reverse}.message.agent{align-self:flex-start}.message.system{align-self:center;max-width:70%}
.msg-avatar{width:28px;height:28px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;margin-top:2px}
.message.user .msg-avatar{background:var(--user-bubble);border:1px solid var(--border-medium)}
.message.agent .msg-avatar{background:linear-gradient(135deg,var(--accent),var(--accent-dim));box-shadow:0 0 10px var(--accent-glow)}
.msg-bubble{padding:10px 14px;border-radius:var(--radius-md);font-size:13.5px;line-height:1.65;white-space:pre-wrap;word-break:break-word}
.message.user .msg-bubble{background:var(--user-bubble);border:1px solid var(--border-medium);border-top-right-radius:4px}
.message.agent .msg-bubble{background:var(--agent-bubble);border:1px solid var(--border-subtle);border-top-left-radius:4px}
.message.system .msg-bubble{background:transparent;border:1px dashed var(--border-medium);color:var(--text-muted);font-size:12px;text-align:center;font-family:var(--font-mono)}
.msg-bubble code{font-family:var(--font-mono);font-size:12px;background:rgba(0,0,0,.3);padding:2px 5px;border-radius:3px}
.msg-bubble pre{background:rgba(0,0,0,.35);padding:10px;border-radius:var(--radius-sm);overflow-x:auto;margin:6px 0;font-family:var(--font-mono);font-size:12px;line-height:1.5;border:1px solid var(--border-subtle)}
.msg-time{font-size:10px;color:var(--text-muted);font-family:var(--font-mono);margin-top:3px;padding:0 4px}
.message.user .msg-time{text-align:right}
.msg-attachments{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.msg-attachment{display:inline-flex;align-items:center;gap:4px;background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.2);border-radius:4px;padding:3px 8px;font-size:11px;color:var(--info);font-family:var(--font-mono)}
.generated-files{margin-top:10px;padding:10px 12px;background:rgba(0,0,0,.2);border:1px solid var(--border-subtle);border-radius:var(--radius-sm)}
.generated-files-label{font-family:var(--font-mono);font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.generated-files-list{display:flex;flex-wrap:wrap;gap:8px}
.gen-file-btn{display:inline-flex;align-items:center;gap:6px;border:1px solid;border-radius:var(--radius-sm);padding:8px 14px;font-size:12px;font-family:var(--font-mono);cursor:pointer;transition:all var(--transition);text-decoration:none}
.gen-file-btn.mailto{background:rgba(96,165,250,.1);border-color:rgba(96,165,250,.2);color:var(--info)}
.gen-file-btn.mailto:hover{background:rgba(96,165,250,.18);border-color:rgba(96,165,250,.35)}
.gen-file-btn.ics{background:rgba(168,85,247,.1);border-color:rgba(168,85,247,.2);color:var(--purple)}
.gen-file-btn.ics:hover{background:rgba(168,85,247,.18);border-color:rgba(168,85,247,.35)}
.gen-file-btn.download{background:rgba(90,100,120,.1);border-color:rgba(90,100,120,.2);color:var(--text-muted);font-size:11px;padding:5px 10px}
.gen-file-btn.download:hover{background:rgba(90,100,120,.18);color:var(--text-secondary)}
.thinking{display:flex;align-items:center;gap:8px;padding:10px 14px;color:var(--text-muted);font-size:13px;animation:msgIn 300ms cubic-bezier(.16,1,.3,1) both}
.thinking-dots{display:flex;gap:4px}
.thinking-dots span{width:6px;height:6px;background:var(--accent-dim);border-radius:50%;animation:dotPulse 1.4s ease-in-out infinite}
.thinking-dots span:nth-child(2){animation-delay:.2s}.thinking-dots span:nth-child(3){animation-delay:.4s}
@keyframes dotPulse{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}

/* INPUT */
.input-area{padding:12px 24px 16px;background:var(--bg-base);border-top:1px solid var(--border-subtle)}
.attachment-bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}.attachment-bar:empty{display:none}
.attachment-chip{display:flex;align-items:center;gap:5px;background:var(--bg-surface);border:1px solid var(--border-medium);border-radius:4px;padding:4px 8px;font-size:11px;color:var(--text-secondary);font-family:var(--font-mono);animation:msgIn 200ms both}
.attachment-chip .remove-file{cursor:pointer;color:var(--text-muted);font-size:14px;line-height:1;transition:color var(--transition)}
.attachment-chip .remove-file:hover{color:var(--error)}
.input-wrapper{display:flex;align-items:flex-end;gap:8px;background:var(--bg-surface);border:1px solid var(--border-medium);border-radius:var(--radius-md);padding:4px;transition:border-color var(--transition),box-shadow var(--transition)}
.input-wrapper:focus-within{border-color:var(--accent-dim);box-shadow:0 0 0 3px var(--accent-glow),0 0 20px var(--accent-glow)}
.input-wrapper textarea{flex:1;background:transparent;border:none;outline:none;color:var(--text-primary);font-family:var(--font-sans);font-size:14px;line-height:1.5;padding:8px 10px;resize:none;max-height:120px;min-height:40px}
.input-wrapper textarea::placeholder{color:var(--text-muted)}
.input-btn{width:36px;height:36px;border-radius:var(--radius-sm);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition);flex-shrink:0;margin:1px}
.attach-btn{background:var(--bg-raised);color:var(--text-muted)}.attach-btn:hover{background:var(--bg-hover);color:var(--text-secondary)}
.send-btn{background:var(--accent);color:var(--bg-void)}.send-btn:hover{background:#4ddb9e;box-shadow:0 0 16px var(--accent-glow-strong)}
.send-btn:active{transform:scale(.94)}.send-btn:disabled{opacity:.3;cursor:not-allowed;box-shadow:none}
.input-btn svg{width:17px;height:17px}
.input-hint{display:flex;align-items:center;justify-content:space-between;margin-top:6px;font-size:11px;color:var(--text-muted);font-family:var(--font-mono);padding:0 4px}
.input-hint kbd{background:var(--bg-raised);padding:1px 5px;border-radius:3px;border:1px solid var(--border-medium);font-size:10px}
#fileInput{display:none}
.drag-overlay{display:none;position:fixed;inset:0;z-index:100;background:rgba(7,8,10,.85);align-items:center;justify-content:center}
.drag-overlay.active{display:flex}
.drag-box{border:2px dashed var(--accent);border-radius:var(--radius-lg);padding:48px 64px;text-align:center;color:var(--accent);font-family:var(--font-mono);font-size:16px}
.drag-box .drag-icon{font-size:40px;margin-bottom:12px}

/* RIGHT PANEL */
.right-panel{background:var(--bg-base);border-left:1px solid var(--border-subtle);display:flex;flex-direction:column;overflow:hidden}
.panel-tabs{display:flex;border-bottom:1px solid var(--border-subtle)}
.panel-tab{flex:1;padding:10px 6px;text-align:center;font-family:var(--font-mono);font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);background:transparent;border:none;cursor:pointer;transition:all var(--transition);border-bottom:2px solid transparent}
.panel-tab:hover{color:var(--text-secondary)}.panel-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.panel-content{flex:1;overflow-y:auto;padding:14px}.panel-content.hidden{display:none}
.task-item{padding:9px 11px;border-radius:var(--radius-sm);border:1px solid var(--border-subtle);margin-bottom:6px;background:var(--bg-surface)}
.task-status{display:inline-block;font-family:var(--font-mono);font-size:10px;font-weight:600;text-transform:uppercase;padding:2px 6px;border-radius:3px;margin-bottom:3px}
.task-status.done{background:rgba(62,207,142,.15);color:var(--accent)}.task-status.running{background:rgba(96,165,250,.15);color:var(--info)}.task-status.failed{background:rgba(239,68,68,.15);color:var(--error)}.task-status.pending{background:rgba(90,100,120,.15);color:var(--text-muted)}
.task-goal{font-size:12px;color:var(--text-secondary);line-height:1.4;margin-top:3px}
.memory-item{padding:9px 11px;border-radius:var(--radius-sm);border:1px solid var(--border-subtle);margin-bottom:6px;background:var(--bg-surface);font-size:12px;color:var(--text-secondary);line-height:1.4}
.memory-source{font-family:var(--font-mono);font-size:10px;color:var(--text-muted);margin-top:3px}
.empty-state{text-align:center;padding:28px 14px;color:var(--text-muted);font-size:13px}
.empty-state-icon{font-size:26px;margin-bottom:6px;opacity:.4}

/* AI VIEW items */
.ai-view-item{padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border-subtle);margin-bottom:8px;background:var(--bg-surface)}
.ai-view-label{font-family:var(--font-mono);font-size:10px;font-weight:600;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px;display:flex;align-items:center;gap:6px}
.ai-view-label .badge{font-size:9px;padding:1px 5px;border-radius:3px}
.ai-view-label .badge.redacted{background:rgba(240,180,41,.15);color:var(--warning)}
.ai-view-label .badge.clean{background:rgba(62,207,142,.1);color:var(--accent)}
.ai-view-original{font-size:12px;color:var(--text-muted);margin-bottom:6px;padding:6px 8px;background:rgba(0,0,0,.2);border-radius:4px;font-family:var(--font-mono);line-height:1.5;white-space:pre-wrap;word-break:break-word}
.ai-view-redacted{font-size:12.5px;color:var(--text-secondary);padding:6px 8px;background:rgba(0,0,0,.15);border-radius:4px;line-height:1.5;white-space:pre-wrap;word-break:break-word}
.ai-view-redacted .placeholder{background:rgba(240,180,41,.15);color:var(--warning);padding:1px 4px;border-radius:3px;font-family:var(--font-mono);font-size:11px}

/* WELCOME */
.welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:36px;text-align:center}
.welcome-icon{width:56px;height:56px;background:linear-gradient(135deg,var(--accent),var(--accent-dim));border-radius:var(--radius-lg);display:flex;align-items:center;justify-content:center;font-size:26px;margin-bottom:16px;box-shadow:0 0 40px var(--accent-glow),0 0 80px var(--accent-glow)}
.welcome h2{font-family:var(--font-mono);font-size:18px;font-weight:600;margin-bottom:6px}
.welcome p{color:var(--text-muted);max-width:400px;font-size:13px;margin-bottom:24px}
.welcome-suggestions{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;max-width:480px}
.suggestion{background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:12px 14px;text-align:left;cursor:pointer;transition:all var(--transition);font-size:12.5px;color:var(--text-secondary);line-height:1.4}
.suggestion:hover{background:var(--bg-hover);border-color:var(--accent-dim);color:var(--text-primary);box-shadow:0 0 20px var(--accent-glow)}
.suggestion .s-icon{font-size:16px;margin-bottom:4px;display:block}

@media(max-width:1024px){.app{grid-template-columns:1fr}.sidebar{display:none}.right-panel{display:none}}

/* Setup Screen */
.setup-overlay{position:fixed;inset:0;z-index:1000;background:var(--bg-void);display:flex;align-items:center;justify-content:center;transition:opacity 0.5s ease}
.setup-overlay.hidden{opacity:0;pointer-events:none}
.setup-box{background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:36px 40px;max-width:520px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.setup-logo{text-align:center;margin-bottom:20px}
.setup-logo .icon{font-size:36px;margin-bottom:8px;display:block}
.setup-logo h2{font-family:var(--font-mono);font-size:20px;font-weight:600}
.setup-logo h2 span{color:var(--accent)}
.setup-logo p{color:var(--text-muted);font-size:13px;margin-top:4px}
.setup-checks{display:flex;flex-direction:column;gap:8px;margin:20px 0}
.setup-check{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg-raised);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);font-size:13px;transition:all 0.3s ease}
.setup-check.checking{color:var(--text-muted);border-color:var(--border-subtle)}
.setup-check.ok{color:var(--accent);border-color:rgba(62,207,142,0.3);background:rgba(62,207,142,0.05)}
.setup-check.warn{color:var(--warning);border-color:rgba(245,158,11,0.3);background:rgba(245,158,11,0.05)}
.setup-check.fail{color:var(--error);border-color:rgba(239,68,68,0.3);background:rgba(239,68,68,0.05)}
.setup-check .check-icon{width:22px;text-align:center;font-size:15px;flex-shrink:0}
.setup-check .check-label{font-family:var(--font-mono);font-size:12px;font-weight:500;min-width:100px}
.setup-check .check-msg{color:var(--text-dim);font-size:12px;flex:1}
.setup-spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--text-muted);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.setup-footer{text-align:center;margin-top:20px}
.setup-btn{background:var(--accent);color:var(--bg-void);border:none;border-radius:var(--radius-sm);padding:10px 28px;font-family:var(--font-mono);font-size:13px;font-weight:600;cursor:pointer;transition:all var(--transition)}
.setup-btn:hover{background:#4ddb9e;box-shadow:0 0 20px var(--accent-glow-strong)}
.setup-btn:disabled{opacity:0.3;cursor:not-allowed}
.setup-status{font-family:var(--font-mono);font-size:12px;margin-bottom:12px}

.app::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");background-size:256px;pointer-events:none;z-index:9999}
</style>
</head>
<body>
<div class="setup-overlay" id="setupOverlay">
  <div class="setup-box">
    <div class="setup-logo">
      <span class="icon">ü§ñ</span>
      <h2>Desktop<span>Agent</span></h2>
      <p>Checking system prerequisites...</p>
    </div>
    <div class="setup-checks" id="setupChecks">
      <div class="setup-check checking" id="chk-python"><span class="check-icon"><span class="setup-spinner"></span></span><span class="check-label">Python</span><span class="check-msg">Checking...</span></div>
      <div class="setup-check checking" id="chk-ollama"><span class="check-icon"><span class="setup-spinner"></span></span><span class="check-label">Ollama</span><span class="check-msg">Checking...</span></div>
      <div class="setup-check checking" id="chk-linkup"><span class="check-icon"><span class="setup-spinner"></span></span><span class="check-label">Linkup Key</span><span class="check-msg">Checking...</span></div>
      <div class="setup-check checking" id="chk-packages"><span class="check-icon"><span class="setup-spinner"></span></span><span class="check-label">Packages</span><span class="check-msg">Checking...</span></div>
      <div class="setup-check checking" id="chk-privacy"><span class="check-icon"><span class="setup-spinner"></span></span><span class="check-label">Privacy</span><span class="check-msg">Checking...</span></div>
      <div class="setup-check checking" id="chk-demo"><span class="check-icon"><span class="setup-spinner"></span></span><span class="check-label">Demo Data</span><span class="check-msg">Checking...</span></div>
    </div>
    <div class="setup-footer">
      <div class="setup-status" id="setupStatus"></div>
      <button class="setup-btn" id="setupBtn" disabled onclick="dismissSetup()">Loading...</button>
    </div>
  </div>
</div>

<div class="app" id="app" style="display:none">
  <div class="drag-overlay" id="dragOverlay"><div class="drag-box"><div class="drag-icon">üìé</div>Drop files here to attach</div></div>

  <header class="topbar">
    <div class="topbar-brand">
      <button class="sidebar-toggle collapsed" id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <div class="topbar-logo">ü§ñ</div>
      <div class="topbar-title">Desktop<span>Agent</span></div>
    </div>
    <div class="topbar-right">
      <div class="privacy-toggle">
        <label onclick="togglePrivacy()">üîí
          <div class="toggle-track on" id="privacyTrack"><div class="toggle-knob"></div></div>
          <span id="privacyLabel">Privacy ON</span>
        </label>
        <span class="privacy-engine" id="privacyEngine"></span>
      </div>
      <div class="status-badge">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">connecting‚Ä¶</span>
      </div>
    </div>
  </header>

  <aside class="sidebar collapsed" id="sidebar">
    <div class="sidebar-inner">
    <div class="sidebar-section">
      <div class="sidebar-label">Tools Available</div>
      <ul class="tool-list">
        <li class="tool-item"><div class="tool-icon search">üîç</div><div class="tool-name">Web Research</div></li>
        <li class="tool-item"><div class="tool-icon email">üìß</div><div class="tool-name">List Emails</div></li>
        <li class="tool-item"><div class="tool-icon email">üì®</div><div class="tool-name">Read Email</div></li>
        <li class="tool-item"><div class="tool-icon email">‚úèÔ∏è</div><div class="tool-name">Draft Reply</div></li>
        <li class="tool-item"><div class="tool-icon doc">üìÑ</div><div class="tool-name">Read Document</div></li>
        <li class="tool-item"><div class="tool-icon doc">üìÅ</div><div class="tool-name">List Documents</div></li>
        <li class="tool-item"><div class="tool-icon doc">üìù</div><div class="tool-name">Summarize Document</div></li>
        <li class="tool-item"><div class="tool-icon cal">üìÖ</div><div class="tool-name">List Events</div></li>
        <li class="tool-item"><div class="tool-icon cal">‚ûï</div><div class="tool-name">Create Event</div></li>
        <li class="tool-item"><div class="tool-icon cal">‚è∞</div><div class="tool-name">Create Reminder</div></li>
        <li class="tool-item"><div class="tool-icon mem">üíæ</div><div class="tool-name">Store Memory</div></li>
        <li class="tool-item"><div class="tool-icon mem">üîé</div><div class="tool-name">Recall Memory</div></li>
      </ul>
    </div>
    <div class="sidebar-section" style="flex:1">
      <div class="sidebar-label">Quick Actions</div>
      <div class="quick-actions">
        <button class="quick-action" onclick="sendQuick('List my recent emails')"><span class="qa-label">üìß Inbox</span>Show my recent emails</button>
        <button class="quick-action" onclick="sendQuick('List my upcoming calendar events')"><span class="qa-label">üìÖ Calendar</span>What's coming up?</button>
        <button class="quick-action" onclick="sendQuick('List available documents')"><span class="qa-label">üìÑ Documents</span>Browse my files</button>
        <button class="quick-action" onclick="sendQuick('What do you remember about our previous interactions?')"><span class="qa-label">üß† Memory</span>What do you recall?</button>
      </div>
    </div>
    </div>
  </aside>

  <main class="chat-area">
    <div class="messages" id="messages">
      <div class="welcome" id="welcome">
        <div class="welcome-icon">ü§ñ</div>
        <h2>Desktop Intelligence Agent</h2>
        <p>Privacy-first AI assistant. Attach files for context, ask anything ‚Äî your sensitive data is automatically redacted before the AI sees it.</p>
        <div class="welcome-suggestions">
          <div class="suggestion" onclick="sendQuick('Draft a reply to the investor email from Acme Corp')"><span class="s-icon">üìß</span>Draft a reply to the investor email from Acme Corp</div>
          <div class="suggestion" onclick="sendQuick('Research the latest AI funding news')"><span class="s-icon">üîç</span>Research the latest AI funding news</div>
          <div class="suggestion" onclick="sendQuick('Create a meeting for tomorrow at 2pm called Project Sync')"><span class="s-icon">üìÖ</span>Schedule a meeting for tomorrow at 2pm</div>
          <div class="suggestion" onclick="sendQuick('Summarize the documents in my folder')"><span class="s-icon">üìÑ</span>Summarize documents in my folder</div>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="attachment-bar" id="attachmentBar"></div>
      <div class="input-wrapper">
        <button class="input-btn attach-btn" onclick="document.getElementById('fileInput').click()" title="Attach files">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
        </button>
        <textarea id="userInput" placeholder="Ask the agent anything‚Ä¶ or drop files here" rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="input-btn send-btn" id="sendBtn" onclick="sendMessage()" disabled title="Send">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
      <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.txt,.md,.png,.jpg,.jpeg,.csv,.xlsx,.eml" onchange="handleFileSelect(this)">
      <div class="input-hint">
        <span><kbd>Enter</kbd> send ¬∑ <kbd>Shift+Enter</kbd> newline ¬∑ üìé attach or drag & drop</span>
        <span id="charCount"></span>
      </div>
    </div>
  </main>

  <aside class="right-panel">
    <div class="panel-tabs">
      <button class="panel-tab active" onclick="switchTab('tasks',this)">Tasks</button>
      <button class="panel-tab" onclick="switchTab('aiview',this)">AI View</button>
      <button class="panel-tab" onclick="switchTab('memory',this)">Memory</button>
    </div>
    <div class="panel-content" id="tasksPanel">
      <div class="empty-state" id="tasksEmpty"><div class="empty-state-icon">üìã</div>No tasks yet.</div>
      <div id="tasksList"></div>
    </div>
    <div class="panel-content hidden" id="aiviewPanel">
      <div class="empty-state" id="aiviewEmpty"><div class="empty-state-icon">üëÅÔ∏è</div>Send a message to see what the AI receives after privacy redaction.</div>
      <div id="aiviewList"></div>
    </div>
    <div class="panel-content hidden" id="memoryPanel">
      <div class="empty-state" id="memoryEmpty"><div class="empty-state-icon">üß†</div>No memories yet.</div>
      <div id="memoryList"></div>
    </div>
  </aside>
</div>

<script>
const API = window.location.origin;
let isProcessing = false, hasMessages = false, privacyEnabled = true;
let pendingFiles = [];
let aiViewLog = []; // Store {original, redacted, time} for AI View tab

const input = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const messagesEl = document.getElementById('messages');
const welcomeEl = document.getElementById('welcome');
const attachmentBar = document.getElementById('attachmentBar');

// SIDEBAR TOGGLE
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const btn = document.getElementById('sidebarToggle');
  sidebar.classList.toggle('collapsed');
  btn.classList.toggle('collapsed');
}

// INIT ‚Äî runs health check, populates setup screen, then shows app
async function init() {
  const statusIcons = { ok: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' };

  function setCheck(id, status, msg) {
    const el = document.getElementById(id);
    if (!el) return;
    el.className = 'setup-check ' + (status === 'ok' ? 'ok' : status === 'warning' ? 'warn' : 'fail');
    el.querySelector('.check-icon').textContent = statusIcons[status] || '‚ùå';
    el.querySelector('.check-msg').textContent = msg;
  }

  function setAllFailed(msg) {
    ['chk-python','chk-ollama','chk-linkup','chk-packages','chk-privacy','chk-demo'].forEach(id => {
      const el = document.getElementById(id);
      if (el && el.classList.contains('checking')) setCheck(id, 'error', msg);
    });
  }

  try {
    const res = await fetch(API + '/api/health');
    if (!res.ok) throw new Error('Health endpoint returned ' + res.status);
    const data = await res.json();
    const c = data.checks;

    // Populate each check
    if (c.python) setCheck('chk-python', c.python.status, c.python.message);
    if (c.ollama) setCheck('chk-ollama', c.ollama.status, c.ollama.message);
    if (c.linkup_api_key) setCheck('chk-linkup', c.linkup_api_key.status, c.linkup_api_key.message);
    if (c.packages) setCheck('chk-packages', c.packages.status, c.packages.message);
    if (c.privacy_engine) setCheck('chk-privacy', c.privacy_engine.status, c.privacy_engine.message);
    if (c.demo_data) setCheck('chk-demo', c.demo_data.status, c.demo_data.message);

    const btn = document.getElementById('setupBtn');
    const statusEl = document.getElementById('setupStatus');

    if (data.healthy) {
      statusEl.style.color = 'var(--accent)';
      statusEl.textContent = '‚úÖ All systems operational';
      btn.textContent = 'Launch Agent';
      btn.disabled = false;
    } else {
      statusEl.style.color = 'var(--warning)';
      statusEl.textContent = '‚ö†Ô∏è Some checks need attention ‚Äî agent may still work';
      btn.textContent = 'Launch Anyway';
      btn.disabled = false;
    }

    // Also init the main app in background
    try {
      const sessionRes = await fetch(API + '/api/session');
      if (sessionRes.ok) {
        const sData = await sessionRes.json();
        document.getElementById('statusDot').classList.remove('offline');
        document.getElementById('statusText').textContent = 'online';
        sendBtn.disabled = false;
        privacyEnabled = sData.privacy_enabled !== false;
        updatePrivacyUI();
        fetchPrivacyEngine();
      }
    } catch(e) {}

  } catch(e) {
    setAllFailed('Server unreachable ‚Äî run: python server.py');
    const btn = document.getElementById('setupBtn');
    const statusEl = document.getElementById('setupStatus');
    statusEl.style.color = 'var(--error)';
    statusEl.textContent = '‚ùå Cannot reach server';
    btn.textContent = 'Retry';
    btn.disabled = false;
    btn.onclick = () => { location.reload(); };

    document.getElementById('statusDot').classList.add('offline');
    document.getElementById('statusText').textContent = 'offline';
    sendBtn.disabled = true;
  }
}

function dismissSetup() {
  const overlay = document.getElementById('setupOverlay');
  overlay.classList.add('hidden');
  document.getElementById('app').style.display = '';
  setTimeout(() => overlay.remove(), 500);
}

async function fetchPrivacyEngine() {
  try { const r = await fetch(API+'/api/privacy'); const d = await r.json(); document.getElementById('privacyEngine').textContent = d.engine==='presidio'?'(NLP)':'(regex)'; } catch(e){}
}

// PRIVACY
function togglePrivacy() {
  privacyEnabled = !privacyEnabled; updatePrivacyUI();
  fetch(API+'/api/privacy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled:privacyEnabled})}).catch(()=>{});
}
function updatePrivacyUI() {
  const t=document.getElementById('privacyTrack'), l=document.getElementById('privacyLabel');
  if(privacyEnabled){t.classList.add('on');l.textContent='Privacy ON'} else{t.classList.remove('on');l.textContent='Privacy OFF'}
}

// FILES
function handleFileSelect(el){for(const f of el.files)addPendingFile(f);el.value=''}
function addPendingFile(f){pendingFiles.push(f);renderAttachmentBar()}
function removePendingFile(i){pendingFiles.splice(i,1);renderAttachmentBar()}
function renderAttachmentBar(){
  attachmentBar.innerHTML=pendingFiles.map((f,i)=>{
    const kb=(f.size/1024).toFixed(1), ic=f.type.startsWith('image/')?'üñºÔ∏è':'üìÑ';
    return `<div class="attachment-chip">${ic} ${esc(f.name)} <span style="color:var(--text-muted)">(${kb}KB)</span><span class="remove-file" onclick="removePendingFile(${i})">√ó</span></div>`;
  }).join('');
  updateSendState();
}
let dc=0;
document.addEventListener('dragenter',e=>{e.preventDefault();dc++;document.getElementById('dragOverlay').classList.add('active')});
document.addEventListener('dragleave',e=>{e.preventDefault();dc--;if(dc<=0){dc=0;document.getElementById('dragOverlay').classList.remove('active')}});
document.addEventListener('dragover',e=>e.preventDefault());
document.addEventListener('drop',e=>{e.preventDefault();dc=0;document.getElementById('dragOverlay').classList.remove('active');for(const f of e.dataTransfer.files)addPendingFile(f)});

// MESSAGES
function addMsg(role, text, extras={}) {
  if(!hasMessages){welcomeEl.style.display='none';hasMessages=true}
  const now=new Date(), ts=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const w=document.createElement('div');w.className=`message ${role}`;
  const av=document.createElement('div');av.className='msg-avatar';av.textContent=role==='user'?'üë§':role==='agent'?'ü§ñ':'‚ÑπÔ∏è';
  const ct=document.createElement('div');
  const bb=document.createElement('div');bb.className='msg-bubble';bb.textContent=text;
  if(extras.attachments&&extras.attachments.length){const ad=document.createElement('div');ad.className='msg-attachments';extras.attachments.forEach(n=>{const c=document.createElement('span');c.className='msg-attachment';c.textContent='üìé '+n;ad.appendChild(c)});bb.appendChild(ad)}
  // Generated files section
  if(extras.generated_files&&extras.generated_files.length){
    const gf=document.createElement('div');gf.className='generated-files';
    gf.innerHTML='<div class="generated-files-label">üìÅ Generated Files</div>';
    const list=document.createElement('div');list.className='generated-files-list';
    extras.generated_files.forEach(f=>{
      if(f.type==='mailto'){
        // Primary: Open in Mail App via mailto: link
        const mailto=document.createElement('a');
        mailto.className='gen-file-btn mailto';
        // Use %0D%0A for line breaks in mailto body (required by Outlook/Windows)
        const mailBody=(f.body||'').replace(/\n/g, '\r\n');
        const mailtoUrl='mailto:'+encodeURIComponent(f.to||'')
          +'?subject='+encodeURIComponent(f.subject||'')
          +'&body='+encodeURIComponent(mailBody);
        mailto.href=mailtoUrl;
        mailto.textContent='üìß Open in Mail App';
        mailto.title='Opens your default email client with this draft';
        list.appendChild(mailto);
        // Secondary: Download .eml
        const dl=document.createElement('a');
        dl.className='gen-file-btn download';
        dl.href=API+'/api/download?path='+encodeURIComponent(f.path);
        dl.target='_blank';
        dl.textContent='‚¨á .eml';
        dl.title='Download as .eml file';
        list.appendChild(dl);
      } else if(f.type==='ics'){
        const dl=document.createElement('a');
        dl.className='gen-file-btn ics';
        dl.href=API+'/api/download?path='+encodeURIComponent(f.path);
        dl.target='_blank';
        dl.textContent='üìÖ '+f.label+' (.ics)';
        list.appendChild(dl);
      } else {
        const dl=document.createElement('a');
        dl.className='gen-file-btn download';
        dl.href=API+'/api/download?path='+encodeURIComponent(f.path);
        dl.target='_blank';
        dl.textContent='üìÑ '+f.label;
        list.appendChild(dl);
      }
    });
    gf.appendChild(list);bb.appendChild(gf);
  }
  const tm=document.createElement('div');tm.className='msg-time';tm.textContent=ts;
  ct.appendChild(bb);ct.appendChild(tm);
  if(role==='system')w.appendChild(ct);else{w.appendChild(av);w.appendChild(ct)}
  messagesEl.appendChild(w);messagesEl.scrollTop=messagesEl.scrollHeight;
}
function addThinking(){const e=document.createElement('div');e.className='thinking';e.id='thinking';e.innerHTML='<div class="thinking-dots"><span></span><span></span><span></span></div><span>Agent is thinking‚Ä¶</span>';messagesEl.appendChild(e);messagesEl.scrollTop=messagesEl.scrollHeight}
function removeThinking(){const e=document.getElementById('thinking');if(e)e.remove()}

// AI VIEW
function addAiView(original, redacted) {
  const time = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  aiViewLog.unshift({original, redacted, time});
  renderAiView();
}
function renderAiView() {
  const list = document.getElementById('aiviewList');
  const empty = document.getElementById('aiviewEmpty');
  if(aiViewLog.length === 0) return;
  empty.style.display = 'none';
  list.innerHTML = aiViewLog.map(item => {
    const hasRedaction = item.original !== item.redacted;
    const badge = hasRedaction
      ? '<span class="badge redacted">redacted</span>'
      : '<span class="badge clean">clean</span>';
    // Highlight placeholders in redacted text
    const highlighted = esc(item.redacted).replace(/&lt;(\w+_\d+)&gt;/g, '<span class="placeholder">&lt;$1&gt;</span>');
    return `<div class="ai-view-item">
      <div class="ai-view-label">üëÅÔ∏è ${item.time} ${badge}</div>
      ${hasRedaction ? `<div class="ai-view-original">You typed: ${esc(item.original)}</div>` : ''}
      <div class="ai-view-redacted">AI received: ${highlighted}</div>
    </div>`;
  }).join('');
}

// SEND
async function sendMessage() {
  const text = input.value.trim();
  if((!text && pendingFiles.length===0) || isProcessing) return;

  const fileNames = pendingFiles.map(f => f.name);
  const savedText = text;
  const savedFiles = [...pendingFiles];

  // *** CLEAR INPUT IMMEDIATELY ***
  input.value = '';
  input.style.height = 'auto';
  pendingFiles = [];
  renderAttachmentBar();
  document.getElementById('charCount').textContent = '';

  addMsg('user', savedText || '(attached files)', {attachments: fileNames.length ? fileNames : undefined});
  isProcessing = true;
  sendBtn.disabled = true;
  addThinking();

  try {
    let res;
    if(savedFiles.length > 0) {
      const form = new FormData();
      form.append('message', savedText || 'Please analyze the attached files.');
      form.append('privacy', privacyEnabled);
      savedFiles.forEach(f => form.append('files', f));
      res = await fetch(API+'/api/chat', {method:'POST', body:form});
    } else {
      res = await fetch(API+'/api/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:savedText, privacy:privacyEnabled})});
    }
    removeThinking();
    if(!res.ok){const e=await res.json();addMsg('system','Error: '+(e.error||'Unknown error'))}
    else {
      const data = await res.json();
      addMsg('agent', data.response, {generated_files: data.generated_files || []});
      // Log to AI View
      if(data.ai_view) addAiView(savedText, data.ai_view);
    }
  } catch(e) {
    removeThinking();
    addMsg('system', 'Connection error: '+e.message+'. Is server.py running?');
  }
  isProcessing = false;
  sendBtn.disabled = false;
  input.focus();
  refreshTasks(); refreshMemory();
}
function sendQuick(t){input.value=t;sendMessage()}

// INPUT
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage()}}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px'}
function updateSendState(){sendBtn.disabled=(input.value.trim().length===0&&pendingFiles.length===0)||isProcessing}
input.addEventListener('input',()=>{updateSendState();document.getElementById('charCount').textContent=input.value.length>0?input.value.length+' chars':''});

// TABS
function switchTab(tab, btn) {
  document.querySelectorAll('.panel-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tasksPanel').classList.toggle('hidden', tab!=='tasks');
  document.getElementById('aiviewPanel').classList.toggle('hidden', tab!=='aiview');
  document.getElementById('memoryPanel').classList.toggle('hidden', tab!=='memory');
}

async function refreshTasks(){
  try{const r=await fetch(API+'/api/tasks');if(!r.ok)return;const d=await r.json();const l=document.getElementById('tasksList');const e=document.getElementById('tasksEmpty');
  if(d.tasks&&d.tasks.length){e.style.display='none';l.innerHTML=d.tasks.map(t=>`<div class="task-item"><span class="task-status ${t.status}">${t.status}</span><div class="task-goal">${esc(t.goal)}</div></div>`).join('')}}catch(e){}
}
async function refreshMemory(){
  try{const r=await fetch(API+'/api/memory?q=recent');if(!r.ok)return;const d=await r.json();const l=document.getElementById('memoryList');const e=document.getElementById('memoryEmpty');
  if(d.memories&&d.memories.length){e.style.display='none';l.innerHTML=d.memories.map(m=>`<div class="memory-item">${esc(m.text||'')}<div class="memory-source">source: ${esc(m.source||'unknown')} ¬∑ score: ${(m.score||0).toFixed(2)}</div></div>`).join('')}}catch(e){}
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
init();
</script>
</body>
</html>
